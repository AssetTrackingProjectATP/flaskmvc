<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGOVTT - Area Audit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    
</head>
<body>
    <div class="sidebar">
        <div class="profile-section">
            <img src="{{ url_for('static', filename='images/profile_icon.png') }}" alt="Profile" class="profile-image">
            <h5 class="mb-1">{{current_user.username}}</h5>
            <small class="text-muted">{{current_user.email}}</small>
        </div>

        <nav>
            <a href="/inventory" class="nav-item">Inventory</a>
            <a href="/audit" class="nav-item active">Area Audit</a>
            <a href="/discrepency-report" class="nav-item">Discrepency Report</a>
        </nav>
        
        <div class="sidebar-bottom">
            <a href="/settings" class="nav-item">Settings</a>
            <a href="/login" class="nav-item text-danger">Log Out</a>
        </div>
    </div>

    <div class="content-area">
        <h2 class="mb-4">Area Audit</h2>
        
        <div class="mb-4">
            <label for="buildingSelect" class="form-label">Select Building</label>
            <select class="form-select" id="buildingSelect" onchange="loadRooms()">
                <option selected>Select Building</option>
                {% for building in buildings %}
                <option value="{{ building.id }}">{{ building.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="mb-4" id="roomSelectContainer" style="display: none;">
            <label for="roomSelect" class="form-label">Select Room</label>
            <select class="form-select" id="roomSelect" onchange="loadRoomAssets()">
                <option selected>Select Room</option>
                <!-- Room options will be populated dynamically -->
            </select>
        </div>
        
<div class="audit-method-buttons mb-4" id="auditMethodButtons" style="display: none;">
    <button class="btn btn-light me-2 audit-method-btn" onclick="setAuditMethod('rfid')">
        <img src="{{ url_for('static', filename='images/rfid_icon.svg') }}" alt="RFID" height="20">
        <span class="btn-text">RFID</span>
    </button>
    <button class="btn btn-light me-2 audit-method-btn" onclick="setAuditMethod('barcode')">
        <img src="{{ url_for('static', filename='images/barcode_icon.svg') }}" alt="Barcode" height="20">
        <span class="btn-text">Barcode</span>
    </button>
    <button class="btn btn-primary audit-method-btn" onclick="setAuditMethod('manual')">
        <img src="{{ url_for('static', filename='images/manual_icon.svg') }}" alt="Manual" height="20">
        <span class="btn-text">Manual</span>
    </button>
</div>
        
        <div class="search-container mb-4" id="searchContainer" style="display: none;">
            <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Search assets">
                <button class="btn btn-primary" id="startScanning">Start Scanning</button>
            </div>
        </div>
        
        <div id="assetList" style="display: none;">
            <h4 class="mt-4 mb-3">Expected Assets in Room</h4>
            <div class="inventory-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Asset Tag</th>
                            <th>Class</th>
                            <th>Assignee</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                            <th>Report</th>
                        </tr>
                    </thead>
                    <tbody id="expectedAssetsTableBody">
                        <!-- Expected assets will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="scannedAssetsList" style="display: none;">
            <h4 class="mt-5 mb-3">Recently Scanned</h4>
            <div class="inventory-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>ID</th>
                            <th>Class</th>
                            <th>Location</th>
                            <th>Condition</th>
                            <th>Last Owner</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="scannedAssetsTableBody">
                        <!-- Scanned assets will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentAuditMethod = 'manual';
        let currentBuilding = null;
        let currentRoom = null;
        let expectedAssets = [];
        let scannedAssets = [];
        
        // Mock data for demonstration
        const buildings = [
            { id: 1, name: 'Building A' },
            { id: 2, name: 'Building B' },
            { id: 3, name: 'Building C' }
        ];
        
        const rooms = {
            1: [ // Building A
                { id: 101, name: 'F1-Room 202' },
                { id: 102, name: 'F1-Room 203' },
                { id: 103, name: 'F2-Room 100' }
            ],
            2: [ // Building B
                { id: 201, name: 'F2-Room 57' },
                { id: 202, name: 'F3-Room 75' }
            ],
            3: [ // Building C
                { id: 301, name: 'F3-Room 76' },
                { id: 302, name: 'F3-Room 77' }
            ]
        };
        
        // Mock asset data
        const assets = {
            101: [ // Room F1-Room 202
                { id: 1001, assetTag: '89342112', item: 'Laptop', class: 'ICT Equipment', condition: 'Good', assignee: 'John Smith', status: 'present' },
                { id: 1002, assetTag: '89342113', item: 'Projector', class: 'ICT Equipment', condition: 'Fair', assignee: 'Mary Johnson', status: 'present' },
                { id: 1003, assetTag: '89342114', item: 'Chair', class: 'Furniture', condition: 'Poor', assignee: 'N/A', status: 'missing' }
            ],
            102: [ // Room F1-Room 203
                { id: 2001, assetTag: '89342115', item: 'Printer', class: 'ICT Equipment', condition: 'Good', assignee: 'Lorenzo Gould-Davies', status: 'present' },
                { id: 2002, assetTag: '89342116', item: 'Desk', class: 'Furniture', condition: 'Excellent', assignee: 'N/A', status: 'present' }
            ]
            // Add more rooms and assets as needed
        };
        
        function loadRooms() {
            const buildingSelect = document.getElementById('buildingSelect');
            currentBuilding = buildingSelect.value;
            
            if (currentBuilding && currentBuilding !== 'Select Building') {
                // Show room select and populate options
                document.getElementById('roomSelectContainer').style.display = 'block';
                const roomSelect = document.getElementById('roomSelect');
                
                // Clear existing options
                roomSelect.innerHTML = '<option selected>Select Room</option>';
                
                // Add room options
                const buildingRooms = rooms[currentBuilding] || [];
                buildingRooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = room.name;
                    roomSelect.appendChild(option);
                });
                
                // Show room buttons
                populateRoomButtons(buildingRooms);
            } else {
                document.getElementById('roomSelectContainer').style.display = 'none';
                document.getElementById('roomButtons').style.display = 'none';
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            }
        }
        
        function populateRoomButtons(rooms) {
            const roomButtonsContainer = document.getElementById('roomButtons');
            roomButtonsContainer.innerHTML = '';
            roomButtonsContainer.style.display = 'block';
            
            rooms.forEach(room => {
                const button = document.createElement('button');
                button.className = 'btn btn-light me-2 mb-2';
                button.textContent = room.name;
                button.value = room.id;
                button.onclick = function() {
                    // Update room select
                    document.getElementById('roomSelect').value = room.id;
                    loadRoomAssets(room.id);
                };
                roomButtonsContainer.appendChild(button);
            });
        }
        
        function loadRoomAssets(roomId = null) {
            if (!roomId) {
                roomId = document.getElementById('roomSelect').value;
            }
            
            if (roomId && roomId !== 'Select Room') {
                currentRoom = roomId;
                
                // Show audit method buttons
                document.getElementById('auditMethodButtons').style.display = 'flex';
                document.getElementById('searchContainer').style.display = 'flex';
                
                // Load and display expected assets for this room
                loadExpectedAssets(roomId);
                
                // Show asset list
                document.getElementById('assetList').style.display = 'block';
                document.getElementById('scannedAssetsList').style.display = 'block';
            } else {
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            }
        }
        
        function loadExpectedAssets(roomId) {
            // In a real app, this would be an API call
            expectedAssets = assets[roomId] || [];
            
            const tableBody = document.getElementById('expectedAssetsTableBody');
            tableBody.innerHTML = '';
            
            expectedAssets.forEach(asset => {
                const row = document.createElement('tr');
                
                // Item
                const itemCell = document.createElement('td');
                itemCell.textContent = asset.item;
                row.appendChild(itemCell);
                
                // Asset Tag
                const assetTagCell = document.createElement('td');
                assetTagCell.textContent = asset.assetTag;
                row.appendChild(assetTagCell);
                
                // Class
                const classCell = document.createElement('td');
                classCell.textContent = asset.class;
                row.appendChild(classCell);
                
                // Condition
                const conditionCell = document.createElement('td');
                const statusDot = document.createElement('span');
                statusDot.className = `status-dot status-${asset.condition.toLowerCase()}`;
                conditionCell.appendChild(statusDot);
                conditionCell.appendChild(document.createTextNode(' ' + asset.condition));
                row.appendChild(conditionCell);
                
                // Assignee
                const assigneeCell = document.createElement('td');
                assigneeCell.textContent = asset.assignee;
                row.appendChild(assigneeCell);
                
                // Status
                const statusCell = document.createElement('td');
                const statusIndicator = document.createElement('span');
                
                if (asset.status === 'present') {
                    statusIndicator.className = 'status-dot status-good';
                    statusCell.appendChild(statusIndicator);
                    statusCell.appendChild(document.createTextNode(' Present'));
                } else {
                    statusIndicator.className = 'status-dot status-poor';
                    statusCell.appendChild(statusIndicator);
                    statusCell.appendChild(document.createTextNode(' Missing'));
                }
                row.appendChild(statusCell);
                
                // Action
                const actionCell = document.createElement('td');
                const markButton = document.createElement('button');
                markButton.className = 'btn btn-sm btn-primary';
                markButton.textContent = asset.status === 'present' ? 'Mark Missing' : 'Mark Present';
                markButton.onclick = function() {
                    // Toggle status
                    asset.status = asset.status === 'present' ? 'missing' : 'present';
                    loadExpectedAssets(currentRoom); // Refresh the list
                };
                actionCell.appendChild(markButton);
                row.appendChild(actionCell);
                
                tableBody.appendChild(row);
            });
            
            // Add mock scanned assets to the scanned assets table
            const scannedTableBody = document.getElementById('scannedAssetsTableBody');
            scannedTableBody.innerHTML = '';
            
            // Just add two mock scanned assets for demonstration
            const mockScannedAssets = [
                { item: 'Laptop', id: '89347112', class: 'ICT Equipment', location: 'F1', condition: 'Missing', lastOwner: 'John Smith', lastUpdated: '12/31/2024' },
                { item: 'Printer', id: '89034782', class: 'ICT Equipment', location: 'F1', condition: 'Good', lastOwner: 'Lorenzo Gould-Davies', lastUpdated: '07/07/2023' }
            ];
            
            mockScannedAssets.forEach(asset => {
                const row = document.createElement('tr');
                
                // Add each cell
                const cells = ['item', 'id', 'class', 'location', 'condition', 'lastOwner', 'lastUpdated'];
                cells.forEach(key => {
                    const cell = document.createElement('td');
                    
                    if (key === 'condition') {
                        const statusDot = document.createElement('span');
                        statusDot.className = `status-dot status-${asset[key].toLowerCase()}`;
                        cell.appendChild(statusDot);
                        cell.appendChild(document.createTextNode(' ' + asset[key]));
                    } else {
                        cell.textContent = asset[key];
                    }
                    
                    row.appendChild(cell);
                });
                
                scannedTableBody.appendChild(row);
            });
        }
        
    function setAuditMethod(method) {
        currentAuditMethod = method;
        
        document.querySelectorAll('.audit-method-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-light');
        });

        const activeBtn = document.querySelector(`.audit-method-btn[onclick="setAuditMethod('${method}')"]`);
        activeBtn.classList.remove('btn-light');
        activeBtn.classList.add('btn-primary');

        // Show search bar only for manual mode
        const searchInput = document.getElementById('searchInput');
        if (method === 'manual') {
            searchInput.style.display = 'block';
            searchInput.placeholder = "Search assets manually...";
        } else {
            searchInput.style.display = 'none';
        }

    // Update button text
    const buttonTexts = {
        manual: 'Start Manual Audit',
        rfid: 'Start RFID Scanning',
        barcode: 'Start Barcode Scanning'
    };
    document.getElementById('startScanning').textContent = buttonTexts[method];
}
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Populate buildings for demonstration
            // In a real app, this would be populated from the server
            const buildingSelect = document.getElementById('buildingSelect');
            buildingSelect.innerHTML = '<option selected>Select Building</option>';
            buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                option.textContent = building.name;
                buildingSelect.appendChild(option);
            });
            
            // Set up event listener for start scanning button
            document.getElementById('startScanning').addEventListener('click', function() {
                alert(`Started ${currentAuditMethod} audit for room ${currentRoom}`);
                // In a real app, this would initiate the scanning process
            });
        });
    </script>
</body>
</html>