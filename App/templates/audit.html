<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGOVTT - Area Audit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <style>
        /* Additional styles for the search container */
        .search-container {
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            gap: 10px; /* Add spacing between search input and button */
        }
        
        /* Style for the fixed scan button */
        #startScanning {
            border-radius: 0.375rem; /* Match Bootstrap's default border-radius */
        }
        
        /* Style for found status */
        .found-yes {
            color: #28a745;
            font-weight: bold;
        }
        
        .found-no {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="profile-section">
            <img src="{{ url_for('static', filename='images/profile_icon.png') }}" alt="Profile" class="profile-image">
            <h5 class="mb-1">{{current_user.username}}</h5>
            <small class="text-muted">{{current_user.email}}</small>
        </div>

        <nav>
            <a href="/inventory" class="nav-item">Inventory</a>
            <a href="/audit" class="nav-item active">Area Audit</a>
            <a href="/discrepency-report" class="nav-item">Discrepency Report</a>
        </nav>
        
        <div class="sidebar-bottom">
            <a href="/settings" class="nav-item">Settings</a>
            <a href="/login" class="nav-item text-danger">Log Out</a>
        </div>
    </div>

    <div class="content-area">
        <h2 class="mb-4">Area Audit</h2>
        
        <div class="mb-4">
            <label for="buildingSelect" class="form-label">Select Building</label>
            <select class="form-select" id="buildingSelect" onchange="loadFloors()">
                <option selected>Select Building</option>
                {% for building in buildings %}
                <option value="{{ building.building_id }}">{{ building.building_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="mb-4" id="floorSelectContainer" style="display: none;">
            <label for="floorSelect" class="form-label">Select Floor</label>
            <select class="form-select" id="floorSelect" onchange="loadRooms()">
                <option selected>Select Floor</option>
                <!-- Floor options will be populated dynamically -->
            </select>
        </div>
        
        <div class="mb-4" id="roomSelectContainer" style="display: none;">
            <label for="roomSelect" class="form-label">Select Room</label>
            <select class="form-select" id="roomSelect" onchange="loadRoomAssets()">
                <option selected>Select Room</option>
                <!-- Room options will be populated dynamically -->
            </select>
        </div>
        
        <div class="audit-method-buttons mb-4" id="auditMethodButtons" style="display: none;">
            <button class="btn btn-light me-2 audit-method-btn" onclick="setAuditMethod('rfid')">
                <img src="{{ url_for('static', filename='images/rfid_icon.svg') }}" alt="RFID" height="20">
                <span class="btn-text">RFID</span>
            </button>
            <button class="btn btn-light me-2 audit-method-btn" onclick="setAuditMethod('barcode')">
                <img src="{{ url_for('static', filename='images/barcode_icon.svg') }}" alt="Barcode" height="20">
                <span class="btn-text">Barcode</span>
            </button>
            <button class="btn btn-primary audit-method-btn" onclick="setAuditMethod('manual')">
                <img src="{{ url_for('static', filename='images/manual_icon.svg') }}" alt="Manual" height="20">
                <span class="btn-text">Manual</span>
            </button>
        </div>
        
        <div class="search-container mb-4" id="searchContainer" style="display: none;">
            <input type="text" class="form-control" id="searchInput" placeholder="Search assets">
            <button class="btn btn-primary w-100" id="startScanning">Start Scanning</button>
        </div>
        
        <div id="assetList" style="display: none;">
            <h4 class="mt-4 mb-3">Expected Assets in Room</h4>
            <div class="inventory-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Asset ID</th>
                            <th>Brand/Model</th>
                            <th>Assignee</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                            <th>Found</th>
                        </tr>
                    </thead>
                    <tbody id="expectedAssetsTableBody">
                        <!-- Expected assets will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="scannedAssetsList" style="display: none;">
            <h4 class="mt-5 mb-3">Recently Scanned</h4>
            <div class="inventory-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Asset ID</th>
                            <th>Brand/Model</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Assignee</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="scannedAssetsTableBody">
                        <!-- Scanned assets will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentAuditMethod = 'manual';
        let currentBuilding = null;
        let currentFloor = null;
        let currentRoom = null;
        let expectedAssets = [];
        let scannedAssets = [];
        
        function loadFloors() {
            const buildingSelect = document.getElementById('buildingSelect');
            currentBuilding = buildingSelect.value;
            
            // Reset floor and room selections
            currentFloor = null;
            currentRoom = null;
            
            if (currentBuilding && currentBuilding !== 'Select Building') {
                // Show floor select and populate options
                document.getElementById('floorSelectContainer').style.display = 'block';
                const floorSelect = document.getElementById('floorSelect');
                
                // Clear existing options
                floorSelect.innerHTML = '<option selected>Select Floor</option>';
                
                // Fetch floors from API
                fetch(`/api/floors/${currentBuilding}`)
                    .then(response => response.json())
                    .then(floors => {
                        floors.forEach(floor => {
                            const option = document.createElement('option');
                            option.value = floor.floor_id;
                            option.textContent = floor.floor_name;
                            floorSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching floors:', error));
                
                // Hide room select and subsequent elements
                document.getElementById('roomSelectContainer').style.display = 'none';
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            } else {
                // Hide all dependent elements
                document.getElementById('floorSelectContainer').style.display = 'none';
                document.getElementById('roomSelectContainer').style.display = 'none';
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            }
        }
        
        function loadRooms() {
            const floorSelect = document.getElementById('floorSelect');
            currentFloor = floorSelect.value;
            
            // Reset room selection
            currentRoom = null;
            
            if (currentFloor && currentFloor !== 'Select Floor') {
                // Show room select and populate options
                document.getElementById('roomSelectContainer').style.display = 'block';
                const roomSelect = document.getElementById('roomSelect');
                
                // Clear existing options
                roomSelect.innerHTML = '<option selected>Select Room</option>';
                
                // Fetch rooms from API
                fetch(`/api/rooms/${currentFloor}`)
                    .then(response => response.json())
                    .then(rooms => {
                        rooms.forEach(room => {
                            const option = document.createElement('option');
                            option.value = room.room_id;
                            option.textContent = room.room_name;
                            roomSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching rooms:', error));
                
                // Hide subsequent elements
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            } else {
                // Hide dependent elements
                document.getElementById('roomSelectContainer').style.display = 'none';
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            }
        }
        
        function loadRoomAssets() {
            const roomSelect = document.getElementById('roomSelect');
            currentRoom = roomSelect.value;
            
            if (currentRoom && currentRoom !== 'Select Room') {
                // Show audit method buttons
                document.getElementById('auditMethodButtons').style.display = 'flex';
                document.getElementById('searchContainer').style.display = 'flex';
                
                // Fetch assets for this room
                fetch(`/api/assets/${currentRoom}`)
                    .then(response => response.json())
                    .then(assets => {
                        expectedAssets = assets;
                        
                        // Reset the found status for all assets
                        expectedAssets.forEach(asset => {
                            asset.found = false;
                        });
                        
                        // Display assets
                        displayExpectedAssets();
                        
                        // Show asset lists
                        document.getElementById('assetList').style.display = 'block';
                        document.getElementById('scannedAssetsList').style.display = 'block';
                    })
                    .catch(error => console.error('Error fetching assets:', error));
            } else {
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            }
        }
        
        function displayExpectedAssets() {
            const tableBody = document.getElementById('expectedAssetsTableBody');
            tableBody.innerHTML = '';
            
            expectedAssets.forEach(asset => {
                const row = document.createElement('tr');
                
                // Description
                const descCell = document.createElement('td');
                descCell.textContent = asset.description;
                row.appendChild(descCell);
                
                // Asset ID
                const idCell = document.createElement('td');
                idCell.textContent = asset.id;
                row.appendChild(idCell);
                
                // Brand/Model
                const brandModelCell = document.createElement('td');
                brandModelCell.textContent = `${asset.brand} ${asset.model}`;
                row.appendChild(brandModelCell);
                
                // Assignee - would need to fetch assignee details separately
                const assigneeCell = document.createElement('td');
                assigneeCell.textContent = asset.assignee_id; // Need to display assignee name instead of ID
                row.appendChild(assigneeCell);
                
                // Status
                const statusCell = document.createElement('td');
                const statusIndicator = document.createElement('span');
                
                if (asset.status === 'present') {
                    statusIndicator.className = 'status-dot status-good';
                    statusCell.appendChild(statusIndicator);
                    statusCell.appendChild(document.createTextNode(' Present'));
                } else {
                    statusIndicator.className = 'status-dot status-poor';
                    statusCell.appendChild(statusIndicator);
                    statusCell.appendChild(document.createTextNode(' ' + asset.status));
                }
                row.appendChild(statusCell);
                
                // Last Updated
                const lastUpdatedCell = document.createElement('td');
                const date = new Date(asset.last_update);
                lastUpdatedCell.textContent = date.toLocaleDateString();
                row.appendChild(lastUpdatedCell);
                
                // Found Status
                const foundCell = document.createElement('td');
                foundCell.id = `found-status-${asset.id}`;
                foundCell.className = asset.found ? 'found-yes' : 'found-no';
                foundCell.textContent = asset.found ? 'YES' : 'NO';
                row.appendChild(foundCell);
                
                tableBody.appendChild(row);
            });
            
            // Clear the scanned assets table
            document.getElementById('scannedAssetsTableBody').innerHTML = '';
        }
        
        function setAuditMethod(method) {
            currentAuditMethod = method;
            
            document.querySelectorAll('.audit-method-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-light');
            });

            const activeBtn = document.querySelector(`.audit-method-btn[onclick="setAuditMethod('${method}')"]`);
            activeBtn.classList.remove('btn-light');
            activeBtn.classList.add('btn-primary');

            // Show search bar only for manual mode
            const searchInput = document.getElementById('searchInput');
            if (method === 'manual') {
                searchInput.style.display = 'block';
                searchInput.placeholder = "Search assets manually...";
            } else {
                searchInput.style.display = 'none';
            }

            // Update button text
            const buttonTexts = {
                manual: 'Start Manual Audit',
                rfid: 'Start RFID Scanning',
                barcode: 'Start Barcode Scanning'
            };
            document.getElementById('startScanning').textContent = buttonTexts[method];
        }
        
        // Function to simulate scanning an asset
        function simulateScanAsset(assetId) {
            // Find the asset in the expected assets list
            const asset = expectedAssets.find(a => a.id === assetId);
            
            if (asset) {
                // Mark the asset as found
                asset.found = true;
                
                // Update the found status in the table
                const foundCell = document.getElementById(`found-status-${asset.id}`);
                if (foundCell) {
                    foundCell.className = 'found-yes';
                    foundCell.textContent = 'YES';
                }
                
                // Add to scanned assets
                if (!scannedAssets.find(a => a.id === asset.id)) {
                    scannedAssets.push(asset);
                    updateScannedAssetsTable();
                }
            }
        }
        
        function updateScannedAssetsTable() {
            const scannedTableBody = document.getElementById('scannedAssetsTableBody');
            scannedTableBody.innerHTML = '';
            
            scannedAssets.forEach(asset => {
                const row = document.createElement('tr');
                
                // Description
                const descCell = document.createElement('td');
                descCell.textContent = asset.description;
                row.appendChild(descCell);
                
                // Asset ID
                const idCell = document.createElement('td');
                idCell.textContent = asset.id;
                row.appendChild(idCell);
                
                // Brand/Model
                const brandModelCell = document.createElement('td');
                brandModelCell.textContent = `${asset.brand} ${asset.model}`;
                row.appendChild(brandModelCell);
                
                // Location
                const locationCell = document.createElement('td');
                locationCell.textContent = asset.room_id; // Would need room name instead of ID
                row.appendChild(locationCell);
                
                // Status
                const statusCell = document.createElement('td');
                const statusIndicator = document.createElement('span');
                statusIndicator.className = `status-dot status-${asset.status === 'present' ? 'good' : 'poor'}`;
                statusCell.appendChild(statusIndicator);
                statusCell.appendChild(document.createTextNode(' ' + asset.status));
                row.appendChild(statusCell);
                
                // Assignee
                const assigneeCell = document.createElement('td');
                assigneeCell.textContent = asset.assignee_id; // Need to display assignee name
                row.appendChild(assigneeCell);
                
                // Last Updated
                const lastUpdatedCell = document.createElement('td');
                const date = new Date(asset.last_update);
                lastUpdatedCell.textContent = date.toLocaleDateString();
                row.appendChild(lastUpdatedCell);
                
                scannedTableBody.appendChild(row);
            });
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listener for start scanning button
            document.getElementById('startScanning').addEventListener('click', function() {
                const buildingName = document.querySelector(`#buildingSelect option[value="${currentBuilding}"]`).textContent;
                const floorName = document.querySelector(`#floorSelect option[value="${currentFloor}"]`).textContent;
                const roomName = document.querySelector(`#roomSelect option[value="${currentRoom}"]`).textContent;
                
                alert(`Started ${currentAuditMethod} audit for ${buildingName}, ${floorName}, ${roomName}`);
                
                // Simulate scanning some assets after a short delay
                if (expectedAssets.length > 0) {
                    setTimeout(() => {
                        simulateScanAsset(expectedAssets[0].id);
                    }, 2000);
                }
            });
            
            // Set up event listener for search input to simulate scanning when user presses Enter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const assetId = this.value.trim();
                    if (assetId) {
                        simulateScanAsset(assetId);
                        this.value = ''; // Clear the input
                    }
                }
            });
        });
    </script>
</body>
</html>