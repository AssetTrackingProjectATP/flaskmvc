<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iGOVTT - Area Audit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <style>
        /* Additional styles for the search container */
        .search-container {
            display: flex;
            flex-direction: column; /* Stack elements vertically */
            gap: 10px; /* Add spacing between search input and button */
        }
        
        /* Style for the fixed scan button */
        #startScanning {
            border-radius: 0.375rem; /* Match Bootstrap's default border-radius */
        }
        
        /* Style for found status */
        .found-yes {
            color: #28a745;
            font-weight: bold;
        }
        
        .found-no {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="profile-section">
            <img src="{{ url_for('static', filename='images/profile_icon.png') }}" alt="Profile" class="profile-image">
            <h5 class="mb-1">{{current_user.username}}</h5>
            <small class="text-muted">{{current_user.email}}</small>
        </div>

        <nav>
            <a href="/inventory" class="nav-item">Inventory</a>
            <a href="/audit" class="nav-item active">Area Audit</a>
            <a href="/discrepency-report" class="nav-item">Discrepency Report</a>
        </nav>
        
        <div class="sidebar-bottom">
            <a href="/settings" class="nav-item">Settings</a>
            <a href="/login" class="nav-item text-danger">Log Out</a>
        </div>
    </div>

    <div class="content-area">
        <h2 class="mb-4">Area Audit</h2>
        
        <div class="mb-4">
            <label for="buildingSelect" class="form-label">Select Building</label>
            <select class="form-select" id="buildingSelect" onchange="loadFloors()">
                <option selected>Select Building</option>
                {% for building in buildings %}
                <option value="{{ building.id }}">{{ building.name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="mb-4" id="floorSelectContainer" style="display: none;">
            <label for="floorSelect" class="form-label">Select Floor</label>
            <select class="form-select" id="floorSelect" onchange="loadRooms()">
                <option selected>Select Floor</option>
                <!-- Floor options will be populated dynamically -->
            </select>
        </div>
        
        <div class="mb-4" id="roomSelectContainer" style="display: none;">
            <label for="roomSelect" class="form-label">Select Room</label>
            <select class="form-select" id="roomSelect" onchange="loadRoomAssets()">
                <option selected>Select Room</option>
                <!-- Room options will be populated dynamically -->
            </select>
        </div>
        
        <div class="audit-method-buttons mb-4" id="auditMethodButtons" style="display: none;">
            <button class="btn btn-light me-2 audit-method-btn" onclick="setAuditMethod('rfid')">
                <img src="{{ url_for('static', filename='images/rfid_icon.svg') }}" alt="RFID" height="20">
                <span class="btn-text">RFID</span>
            </button>
            <button class="btn btn-light me-2 audit-method-btn" onclick="setAuditMethod('barcode')">
                <img src="{{ url_for('static', filename='images/barcode_icon.svg') }}" alt="Barcode" height="20">
                <span class="btn-text">Barcode</span>
            </button>
            <button class="btn btn-primary audit-method-btn" onclick="setAuditMethod('manual')">
                <img src="{{ url_for('static', filename='images/manual_icon.svg') }}" alt="Manual" height="20">
                <span class="btn-text">Manual</span>
            </button>
        </div>
        
        <div class="search-container mb-4" id="searchContainer" style="display: none;">
            <input type="text" class="form-control" id="searchInput" placeholder="Search assets">
            <button class="btn btn-primary w-100" id="startScanning">Start Scanning</button>
        </div>
        
        <div id="assetList" style="display: none;">
            <h4 class="mt-4 mb-3">Expected Assets in Room</h4>
            <div class="inventory-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Asset Tag</th>
                            <th>Class</th>
                            <th>Assignee</th>
                            <th>Status</th>
                            <th>Last Updated</th>
                            <th>Found</th>
                        </tr>
                    </thead>
                    <tbody id="expectedAssetsTableBody">
                        <!-- Expected assets will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="scannedAssetsList" style="display: none;">
            <h4 class="mt-5 mb-3">Recently Scanned</h4>
            <div class="inventory-table">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>ID</th>
                            <th>Class</th>
                            <th>Location</th>
                            <th>Condition</th>
                            <th>Last Owner</th>
                            <th>Last Updated</th>
                        </tr>
                    </thead>
                    <tbody id="scannedAssetsTableBody">
                        <!-- Scanned assets will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let currentAuditMethod = 'manual';
        let currentBuilding = null;
        let currentFloor = null;
        let currentRoom = null;
        let expectedAssets = [];
        let scannedAssets = [];
        
        // Mock data for demonstration
        const buildings = [
            { id: 1, name: 'Building A' },
            { id: 2, name: 'Building B' },
            { id: 3, name: 'Building C' }
        ];
        
        // Mock floor data
        const floors = {
            1: [ // Building A
                { id: 1, name: 'Floor 1' },
                { id: 2, name: 'Floor 2' },
                { id: 3, name: 'Floor 3' }
            ],
            2: [ // Building B
                { id: 1, name: 'Floor 1' },
                { id: 2, name: 'Floor 2' }
            ],
            3: [ // Building C
                { id: 1, name: 'Floor 1' },
                { id: 2, name: 'Floor 2' },
                { id: 3, name: 'Floor 3' }
            ]
        };
        
        // Mock room data - revised to be per floor
        const rooms = {
            '1-1': [ // Building 1, Floor 1
                { id: 101, name: 'Room 101' },
                { id: 102, name: 'Room 102' },
                { id: 103, name: 'Room 103' }
            ],
            '1-2': [ // Building 1, Floor 2
                { id: 201, name: 'Room 201' },
                { id: 202, name: 'Room 202' }
            ],
            '2-1': [ // Building 2, Floor 1
                { id: 301, name: 'Room 57' },
                { id: 302, name: 'Room 58' }
            ],
            '2-2': [ // Building 2, Floor 2
                { id: 401, name: 'Room 75' },
                { id: 402, name: 'Room 76' }
            ]
            // Add more floor-room combinations as needed
        };
        
        // Mock asset data - added found property
        const assets = {
            101: [ // Room 101
                { id: 1001, assetTag: '89342112', item: 'Laptop', class: 'ICT Equipment', condition: 'Good', assignee: 'John Smith', status: 'present', found: false },
                { id: 1002, assetTag: '89342113', item: 'Projector', class: 'ICT Equipment', condition: 'Fair', assignee: 'Mary Johnson', status: 'present', found: false },
                { id: 1003, assetTag: '89342114', item: 'Chair', class: 'Furniture', condition: 'Poor', assignee: 'N/A', status: 'missing', found: false }
            ],
            102: [ // Room 102
                { id: 2001, assetTag: '89342115', item: 'Printer', class: 'ICT Equipment', condition: 'Good', assignee: 'Lorenzo Gould-Davies', status: 'present', found: false },
                { id: 2002, assetTag: '89342116', item: 'Desk', class: 'Furniture', condition: 'Excellent', assignee: 'N/A', status: 'present', found: false }
            ]
            // Add more rooms and assets as needed
        };
        
        function loadFloors() {
            const buildingSelect = document.getElementById('buildingSelect');
            currentBuilding = buildingSelect.value;
            
            // Reset floor and room selections
            currentFloor = null;
            currentRoom = null;
            
            if (currentBuilding && currentBuilding !== 'Select Building') {
                // Show floor select and populate options
                document.getElementById('floorSelectContainer').style.display = 'block';
                const floorSelect = document.getElementById('floorSelect');
                
                // Clear existing options
                floorSelect.innerHTML = '<option selected>Select Floor</option>';
                
                // Add floor options
                const buildingFloors = floors[currentBuilding] || [];
                buildingFloors.forEach(floor => {
                    const option = document.createElement('option');
                    option.value = floor.id;
                    option.textContent = floor.name;
                    floorSelect.appendChild(option);
                });
                
                // Hide room select and subsequent elements
                document.getElementById('roomSelectContainer').style.display = 'none';
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            } else {
                // Hide all dependent elements
                document.getElementById('floorSelectContainer').style.display = 'none';
                document.getElementById('roomSelectContainer').style.display = 'none';
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            }
        }
        
        function loadRooms() {
            const floorSelect = document.getElementById('floorSelect');
            currentFloor = floorSelect.value;
            
            // Reset room selection
            currentRoom = null;
            
            if (currentFloor && currentFloor !== 'Select Floor') {
                // Show room select and populate options
                document.getElementById('roomSelectContainer').style.display = 'block';
                const roomSelect = document.getElementById('roomSelect');
                
                // Clear existing options
                roomSelect.innerHTML = '<option selected>Select Room</option>';
                
                // Create the key for rooms object
                const floorKey = `${currentBuilding}-${currentFloor}`;
                
                // Add room options
                const floorRooms = rooms[floorKey] || [];
                floorRooms.forEach(room => {
                    const option = document.createElement('option');
                    option.value = room.id;
                    option.textContent = room.name;
                    roomSelect.appendChild(option);
                });
                
                // Hide subsequent elements
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            } else {
                // Hide dependent elements
                document.getElementById('roomSelectContainer').style.display = 'none';
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            }
        }
        
        function loadRoomAssets(roomId = null) {
            if (!roomId) {
                roomId = document.getElementById('roomSelect').value;
            }
            
            if (roomId && roomId !== 'Select Room') {
                currentRoom = roomId;
                
                // Show audit method buttons
                document.getElementById('auditMethodButtons').style.display = 'flex';
                document.getElementById('searchContainer').style.display = 'flex';
                
                // Reset the found status for all assets in the room
                if (assets[roomId]) {
                    assets[roomId].forEach(asset => {
                        asset.found = false;
                    });
                }
                
                // Load and display expected assets for this room
                loadExpectedAssets(roomId);
                
                // Show asset list
                document.getElementById('assetList').style.display = 'block';
                document.getElementById('scannedAssetsList').style.display = 'block';
            } else {
                document.getElementById('auditMethodButtons').style.display = 'none';
                document.getElementById('searchContainer').style.display = 'none';
                document.getElementById('assetList').style.display = 'none';
                document.getElementById('scannedAssetsList').style.display = 'none';
            }
        }
        
        function loadExpectedAssets(roomId) {
            // In a real app, this would be an API call
            expectedAssets = assets[roomId] || [];
            
            const tableBody = document.getElementById('expectedAssetsTableBody');
            tableBody.innerHTML = '';
            
            expectedAssets.forEach(asset => {
                const row = document.createElement('tr');
                
                // Item
                const itemCell = document.createElement('td');
                itemCell.textContent = asset.item;
                row.appendChild(itemCell);
                
                // Asset Tag
                const assetTagCell = document.createElement('td');
                assetTagCell.textContent = asset.assetTag;
                row.appendChild(assetTagCell);
                
                // Class
                const classCell = document.createElement('td');
                classCell.textContent = asset.class;
                row.appendChild(classCell);
                
                // Assignee
                const assigneeCell = document.createElement('td');
                assigneeCell.textContent = asset.assignee;
                row.appendChild(assigneeCell);
                
                // Status
                const statusCell = document.createElement('td');
                const statusIndicator = document.createElement('span');
                
                if (asset.status === 'present') {
                    statusIndicator.className = 'status-dot status-good';
                    statusCell.appendChild(statusIndicator);
                    statusCell.appendChild(document.createTextNode(' Present'));
                } else {
                    statusIndicator.className = 'status-dot status-poor';
                    statusCell.appendChild(statusIndicator);
                    statusCell.appendChild(document.createTextNode(' Missing'));
                }
                row.appendChild(statusCell);
                
                // Last Updated
                const lastUpdatedCell = document.createElement('td');
                lastUpdatedCell.textContent = '02/20/2025'; // Mock date
                row.appendChild(lastUpdatedCell);
                
                // Found Status
                const foundCell = document.createElement('td');
                foundCell.id = `found-status-${asset.id}`;
                foundCell.className = asset.found ? 'found-yes' : 'found-no';
                foundCell.textContent = asset.found ? 'YES' : 'NO';
                row.appendChild(foundCell);
                
                tableBody.appendChild(row);
            });
            
            // Add mock scanned assets to the scanned assets table
            updateScannedAssetsTable();
        }
        
        function updateScannedAssetsTable() {
            const scannedTableBody = document.getElementById('scannedAssetsTableBody');
            scannedTableBody.innerHTML = '';
            
            // Just add two mock scanned assets for demonstration
            const mockScannedAssets = [
                { item: 'Laptop', id: '89347112', class: 'ICT Equipment', location: 'F1', condition: 'Good', lastOwner: 'John Smith', lastUpdated: '12/31/2024' },
                { item: 'Printer', id: '89034782', class: 'ICT Equipment', location: 'F1', condition: 'Good', lastOwner: 'Lorenzo Gould-Davies', lastUpdated: '07/07/2023' }
            ];
            
            mockScannedAssets.forEach(asset => {
                const row = document.createElement('tr');
                
                // Add each cell
                const cells = ['item', 'id', 'class', 'location', 'condition', 'lastOwner', 'lastUpdated'];
                cells.forEach(key => {
                    const cell = document.createElement('td');
                    
                    if (key === 'condition') {
                        const statusDot = document.createElement('span');
                        statusDot.className = `status-dot status-${asset[key].toLowerCase()}`;
                        cell.appendChild(statusDot);
                        cell.appendChild(document.createTextNode(' ' + asset[key]));
                    } else {
                        cell.textContent = asset[key];
                    }
                    
                    row.appendChild(cell);
                });
                
                scannedTableBody.appendChild(row);
            });
        }
        
        function setAuditMethod(method) {
            currentAuditMethod = method;
            
            document.querySelectorAll('.audit-method-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-light');
            });

            const activeBtn = document.querySelector(`.audit-method-btn[onclick="setAuditMethod('${method}')"]`);
            activeBtn.classList.remove('btn-light');
            activeBtn.classList.add('btn-primary');

            // Show search bar only for manual mode
            const searchInput = document.getElementById('searchInput');
            if (method === 'manual') {
                searchInput.style.display = 'block';
                searchInput.placeholder = "Search assets manually...";
            } else {
                searchInput.style.display = 'none';
            }

            // Update button text
            const buttonTexts = {
                manual: 'Start Manual Audit',
                rfid: 'Start RFID Scanning',
                barcode: 'Start Barcode Scanning'
            };
            document.getElementById('startScanning').textContent = buttonTexts[method];
        }
        
        // Function to simulate scanning an asset
        function simulateScanAsset(assetTag) {
            if (!currentRoom || !assets[currentRoom]) return;
            
            // Find the asset in the expected assets list
            const asset = assets[currentRoom].find(a => a.assetTag === assetTag);
            
            if (asset) {
                // Mark the asset as found
                asset.found = true;
                
                // Update the found status in the table
                const foundCell = document.getElementById(`found-status-${asset.id}`);
                if (foundCell) {
                    foundCell.className = 'found-yes';
                    foundCell.textContent = 'YES';
                }
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Populate buildings for demonstration
            // In a real app, this would be populated from the server
            const buildingSelect = document.getElementById('buildingSelect');
            buildingSelect.innerHTML = '<option selected>Select Building</option>';
            buildings.forEach(building => {
                const option = document.createElement('option');
                option.value = building.id;
                option.textContent = building.name;
                buildingSelect.appendChild(option);
            });
            
            // Set up event listener for start scanning button
            document.getElementById('startScanning').addEventListener('click', function() {
                const buildingName = document.querySelector(`#buildingSelect option[value="${currentBuilding}"]`).textContent;
                const floorName = document.querySelector(`#floorSelect option[value="${currentFloor}"]`).textContent;
                const roomName = document.querySelector(`#roomSelect option[value="${currentRoom}"]`).textContent;
                
                alert(`Started ${currentAuditMethod} audit for ${buildingName}, ${floorName}, ${roomName}`);
                
                // Simulate scanning some assets after a short delay
                setTimeout(() => {
                    if (currentRoom === '101') {
                        simulateScanAsset('89342112'); // Scan the Laptop
                    } else if (currentRoom === '102') {
                        simulateScanAsset('89342115'); // Scan the Printer
                    }
                }, 2000);
            });
            
            // Set up event listener for search input to simulate scanning when user presses Enter
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    const assetTag = this.value.trim();
                    if (assetTag) {
                        simulateScanAsset(assetTag);
                        this.value = ''; // Clear the input
                    }
                }
            });
        });
    </script>
</body>
</html>